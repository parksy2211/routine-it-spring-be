name: Publish API Documentation to GitBook

on:
  push:
    branches: [develop]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'gradle/**'
  workflow_dispatch:

jobs:
  publish-docs:
    runs-on: ubuntu-latest
    
    if: github.repository == 'Goorda-Goormi/routine-it-spring-be'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build & Generate OpenAPI
        env:
          SPRING_PROFILES_ACTIVE: ci
        run: |
          echo "Building application..."
          ./gradlew clean build -x test
          
          echo "Starting application with CI profile..."
          # ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘í•˜ì—¬ OpenAPI JSON ìƒì„±
          nohup ./gradlew bootRun --args='--spring.profiles.active=ci' > app.log 2>&1 &
          APP_PID=$!
          
          echo "Waiting for application to start..."
          TIMEOUT=60
          for i in $(seq 1 $TIMEOUT); do
            if curl -s http://localhost:8080/api/health > /dev/null 2>&1; then
              echo "âœ… Application started successfully after ${i} seconds"
              
              # Health check ì‘ë‹µ í™•ì¸
              echo "Health check response:"
              curl -s http://localhost:8080/api/health | head -100
              echo ""
              
              break
            fi
            if [ $i -eq $TIMEOUT ]; then
              echo "âŒ Application failed to start within $TIMEOUT seconds"
              echo "Application logs:"
              cat app.log
              echo "Process status:"
              ps aux | grep java || true
              echo "Network status:"
              netstat -tlnp | grep 8080 || true
              exit 1
            fi
            sleep 1
          done
          
          # SpringDocì´ ì´ˆê¸°í™”ë  ì‹œê°„ì„ ì¶”ê°€ë¡œ ì œê³µ
          echo "Waiting for SpringDoc to initialize..."
          sleep 5
          
          echo "Downloading OpenAPI JSON..."
          # ì‚¬ìš© ê°€ëŠ¥í•œ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
          echo "Testing endpoints:"
          echo "1. Health check ping:"
          curl -s http://localhost:8080/api/health/ping && echo ""
          
          echo "2. Health check full:"
          curl -s http://localhost:8080/api/health | python3 -m json.tool 2>/dev/null || echo "Failed to get health"
          
          # OpenAPI ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
          echo "3. Checking OpenAPI endpoint (should return 200):"
          curl -I http://localhost:8080/v3/api-docs 2>&1 | head -3
          
          # OpenAPI JSON ë‹¤ìš´ë¡œë“œ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          for attempt in 1 2 3; do
            echo "Attempt $attempt to download OpenAPI JSON..."
            curl -s http://localhost:8080/v3/api-docs -o openapi.json
            
            if [ -s openapi.json ] && grep -q '"openapi"' openapi.json; then
              echo "Successfully downloaded on attempt $attempt"
              break
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "Retrying in 3 seconds..."
              sleep 3
            fi
          done
          
          # íŒŒì¼ ë‚´ìš© í™•ì¸
          echo "OpenAPI JSON content (first 500 chars):"
          head -c 500 openapi.json || echo "File is empty"
          echo ""
          
          echo "ğŸ›‘ Stopping application..."
          kill $APP_PID || true
          
          # í”„ë¡œì„¸ìŠ¤ê°€ ì™„ì „íˆ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
          sleep 5
          
          # OpenAPI JSON ê²€ì¦
          if [ -s openapi.json ]; then
            # ì‹¤ì œ JSONì¸ì§€ í™•ì¸
            if grep -q '"openapi"' openapi.json; then
              echo "âœ… OpenAPI JSON generated successfully"
              echo "File size: $(wc -c < openapi.json) bytes"
            else
              echo "âŒ File exists but doesn't contain valid OpenAPI spec"
              echo "Full content:"
              cat openapi.json
              exit 1
            fi
          else
            echo "âŒ Failed to generate OpenAPI JSON (file is empty)"
            echo "Checking application logs for errors:"
            tail -50 app.log
            exit 1
          fi

      - name: Install GitBook CLI
        run: |
          echo "Installing GitBook CLI..."
          npm install -g @gitbook/cli@latest
          echo "GitBook CLI version:"
          gitbook --version

      - name: Validate OpenAPI JSON
        run: |
          echo "Validating OpenAPI JSON..."
          if [ ! -s openapi.json ]; then
            echo "âŒ OpenAPI JSON file is empty or doesn't exist"
            exit 1
          fi
          
          # OpenAPI JSON ìœ íš¨ì„± ê²€ì‚¬
          node -e "
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('openapi.json', 'utf8'));
              console.log('âœ… OpenAPI JSON is valid');
              console.log('  - OpenAPI version:', data.openapi);
              console.log('  - Title:', data.info?.title);
              console.log('  - Version:', data.info?.version);
              console.log('  - Paths count:', Object.keys(data.paths || {}).length);
              console.log('  - File size:', fs.statSync('openapi.json').size, 'bytes');
            } catch (error) {
              console.error('âŒ Invalid OpenAPI JSON:', error.message);
              process.exit(1);
            }
          "

      - name: Publish OpenAPI Spec to GitBook
        env:
          GITBOOK_TOKEN: ${{ secrets.GITBOOK_TOKEN }}
        run: |
          echo "ğŸ“š Publishing to GitBook..."
          echo "Organization: ${{ secrets.GITBOOK_ORG }}"
          echo "Spec ID: ${{ secrets.GITBOOK_SPEC }}"
          
          # GitBook Secrets í™•ì¸
          if [ -z "$GITBOOK_TOKEN" ]; then
            echo "âŒ GITBOOK_TOKEN secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.GITBOOK_ORG }}" ]; then
            echo "âŒ GITBOOK_ORG secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.GITBOOK_SPEC }}" ]; then
            echo "âŒ GITBOOK_SPEC secret is not set"
            exit 1
          fi
          
          # GitBookì— ì—…ë¡œë“œ
          gitbook openapi publish \
            --organization "${{ secrets.GITBOOK_ORG }}" \
            --spec "${{ secrets.GITBOOK_SPEC }}" \
            openapi.json
          
          echo "âœ… Successfully published to GitBook"

      - name: Upload OpenAPI JSON as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.json
          retention-days: 30 